.. _2step_enrollment:

Two Step Enrollment
===================

.. index:: privacyIDEA Authenticator, twostep, 2step

Starting with version 2.21 privacyIDEA allows to enroll smartphone based tokens in a
2step enrollment.

With the rise of the smartphones and the fact that every user has a smartphone, carries it
with him all the time and cares about it a lot, using the smartphone for authentication
gets more and more attractive to IT departments.

Google came up with the Key URI [#keyuri]_ to use a QR code to easily enroll
a smartphone token, i.e. transport the OTP secret from the server to the phone.
However this bears some security issues as already pointed out [#problem]_.

This is why privacyIDEA allows to generate the OTP secret from a server component
and from a client component (generated by the smartphone). This way the enrolled
token is more tightly bound to this single smartphone and can not be copied that easily
anymore.

Workflow
--------

In a two step enrollment process the user clicks in the Web UI to enroll a token.
The server generates a QR code and the user will scan this QR code
with his smartphone app. The QR code contains the server component of the key
and the information, that a second component is needed.

The smartphone generates the second component and displays this to the
user.

The user enters this second component into the privacyIDEA Web UI.

Both the smartphone and the server calculate the OTP secret from
both components.

Two Step policies
-----------------

Two step enrollment is controlled by policies in the ``admin``/``user`` scope and
in the ``enrollment`` scope.

Thus the administrator can *allow* or *force* a user (or other administrators) to
do a two step enrollment. This way it is possible to avoid the enrollment of insecure
Google Authenticator QR codes in the complete installation. (:ref:`user_policy_2step`).

The default behaviour is to now allow a two step enrollment. Only if a corresponding
``admin`` or ``user`` policy is defined, two step enrollment is possible.

Key generation
~~~~~~~~~~~~~~

In addition the administrator can define an ``enrollment`` policy to specify
necessary parameters for the key generation.

Two step enrollment is possible for HOTP and TOTP tokens. Thus the administrator
can define token type specific policies in the scope ``enrollment``:
``hotp_clientsize``, ``totp_clientsize``, ``hotp_difficulty``...
see :ref:`2step_parameters`.

privacyIDEA Authenticator
-------------------------

The privacyIDEA Authenticator [#authenticator]_ that is available from the
Google Play Store supports the two step enrollment.

Specification
-------------

The two step enrollment simply adds some parameters to the originial Key URI.

**2step_output**

This is the resulting key size, which the smartphone should generate.

**2step_salt**

This is the length of the client component that the smartphone should generate.

**2step_difficulty**

This is the number of rounds for the PBKDF2 that the smartphone should use
to generated the OTP secret.

.. [#keyuri] https://github.com/google/google-authenticator/wiki/Key-Uri-Format
.. [#problem] https://netknights.it/en/the-problem-with-the-google-authenticator/
.. [#authenticator] https://play.google.com/store/apps/details?id=it.netknights.piauthenticator
